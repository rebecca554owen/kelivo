name: Flutter Multi-Platform Build

env:
  FLUTTER_VERSION: '3.35.7'  # ä¿®æ”¹ä¸ºä½ éœ€è¦çš„ Flutter ç‰ˆæœ¬

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      # é€‰æ‹©æ„å»ºçš„å¹³å°
      build_android:
        description: 'æ„å»º Android'
        required: false
        default: true
        type: boolean

      build_ios:
        description: 'æ„å»º iOS'
        required: false
        default: true
        type: boolean

      build_mac:
        description: 'æ„å»º macOS'
        required: false
        default: true
        type: boolean

      build_windows:
        description: 'æ„å»º Windows'
        required: false
        default: true
        type: boolean

      build_linux:
        description: 'æ„å»º Linux'
        required: false
        default: true
        type: boolean

      # æ˜¯å¦å‘å¸ƒåˆ° Releaseï¼ˆé»˜è®¤ä¸å‘å¸ƒï¼‰
      publish_release:
        description: 'å‘å¸ƒåˆ° Release'
        required: false
        default: false
        type: boolean

      # Release æ ‡ç­¾ï¼ˆåªæœ‰é€‰æ‹©å‘å¸ƒæ—¶æ‰éœ€è¦å¡«å†™ï¼‰
      release_tag:
        description: 'Release æ ‡ç­¾ï¼ˆå¦‚ v1.0.0ï¼‰'
        required: false
        default: ''
        type: string

jobs:
  # Android æ„å»º
  android:
    if: ${{ github.event.inputs.build_android == 'true' }}
    name: æ„å»º Android
    runs-on: ubuntu-latest
    permissions: write-all

    steps:
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• é…ç½® Java ç¯å¢ƒ
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: ğŸ¦ å®‰è£… Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ğŸ“ è·å–ç‰ˆæœ¬å·
        id: version
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ç‰ˆæœ¬å·: $VERSION"

      # å¦‚æœæœ‰ç­¾åå¯†é’¥ï¼Œå†™å…¥å¯†é’¥æ–‡ä»¶
      - name: ğŸ”‘ å†™å…¥ç­¾åå¯†é’¥
        if: ${{ env.SIGN_KEYSTORE_BASE64 != '' }}
        env:
          SIGN_KEYSTORE_BASE64: ${{ secrets.SIGN_KEYSTORE_BASE64 }}
        run: |
          echo "$SIGN_KEYSTORE_BASE64" | base64 --decode > android/app/key.jks
          echo "storeFile=key.jks" >> android/key.properties
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          echo "âœ… ç­¾åé…ç½®å·²å†™å…¥"

      - name: ğŸ—ï¸ æ„å»º APK
        run: flutter build apk --release --split-per-abi

      - name: ğŸ“¦ é‡å‘½å APK
        run: |
          cd build/app/outputs/flutter-apk
          for file in app-*-release.apk; do
            abi=$(echo "$file" | sed -E 's/app-(.*)-release\.apk/\1/')
            mv "$file" "Kelivo_android_${VERSION}_${abi}.apk"
          done

      - name: ğŸš€ å‘å¸ƒåˆ° Release
        if: ${{ github.event.inputs.publish_release == 'true' && github.event.inputs.release_tag != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: ${{ github.event.inputs.release_tag }}
          files: build/app/outputs/flutter-apk/Kelivo_android_*.apk

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰© (arm64-v8a)
        uses: actions/upload-artifact@v4
        with:
          name: Android-arm64-v8a
          path: build/app/outputs/flutter-apk/Kelivo_android_*_arm64-v8a.apk

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰© (armeabi-v7a)
        uses: actions/upload-artifact@v4
        with:
          name: Android-armeabi-v7a
          path: build/app/outputs/flutter-apk/Kelivo_android_*_armeabi-v7a.apk

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰© (x86_64)
        uses: actions/upload-artifact@v4
        with:
          name: Android-x86_64
          path: build/app/outputs/flutter-apk/Kelivo_android_*_x86_64.apk

  # iOS æ„å»º
  ios:
    if: ${{ github.event.inputs.build_ios == 'true' }}
    name: æ„å»º iOS
    runs-on: macos-latest
    permissions: write-all

    steps:
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ¦ å®‰è£… Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ğŸ“ è·å–ç‰ˆæœ¬å·
        id: version
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ç‰ˆæœ¬å·: $VERSION"

      - name: ğŸ—ï¸ æ„å»º iOS (æ— ç­¾å)
        run: |
          flutter build ios --release --no-codesign
          cd build/ios/iphoneos
          mkdir Payload
          cp -r Runner.app Payload/
          zip -r ../../../Kelivo_ios_${VERSION}.ipa Payload

      - name: ğŸš€ å‘å¸ƒåˆ° Release
        if: ${{ github.event.inputs.publish_release == 'true' && github.event.inputs.release_tag != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: ${{ github.event.inputs.release_tag }}
          files: Kelivo_ios_*.ipa

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: iOS-IPA
          path: Kelivo_ios_*.ipa

  # macOS æ„å»º
  macos:
    if: ${{ github.event.inputs.build_mac == 'true' }}
    name: æ„å»º macOS
    runs-on: macos-latest
    permissions: write-all

    steps:
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ¦ å®‰è£… Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ğŸ“ è·å–ç‰ˆæœ¬å·
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: ğŸ—ï¸ æ„å»º macOS
        run: flutter build macos --release

      - name: ğŸ“¦ åˆ›å»º DMG
        run: |
          brew install create-dmg
          create-dmg \
            --volname "Kelivo" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --app-drop-link 600 185 \
            "Kelivo_macos_${VERSION}.dmg" \
            "build/macos/Build/Products/Release/kelivo.app" || true
          # å¦‚æœ create-dmg å¤±è´¥ï¼Œä½¿ç”¨ç®€å•æ–¹å¼
          if [ ! -f "Kelivo_macos_${VERSION}.dmg" ]; then
            hdiutil create -volname Kelivo -srcfolder build/macos/Build/Products/Release/kelivo.app -ov -format UDZO Kelivo_macos_${VERSION}.dmg
          fi

      - name: ğŸš€ å‘å¸ƒåˆ° Release
        if: ${{ github.event.inputs.publish_release == 'true' && github.event.inputs.release_tag != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: ${{ github.event.inputs.release_tag }}
          files: Kelivo_macos_*.dmg

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: macOS-DMG
          path: Kelivo_macos_*.dmg

  # Windows æ„å»º
  windows:
    if: ${{ github.event.inputs.build_windows == 'true' }}
    name: æ„å»º Windows
    runs-on: windows-latest
    permissions: write-all

    steps:
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ¦ å®‰è£… Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ğŸ“ è·å–ç‰ˆæœ¬å·
        shell: pwsh
        run: |
          $version = (Select-String -Path pubspec.yaml -Pattern "version:" | ForEach-Object { $_.Line.Split(":")[1].Trim() })
          echo "VERSION=$version" >> $env:GITHUB_ENV
          Write-Host "ç‰ˆæœ¬å·: $version"

      - name: ğŸ—ï¸ æ„å»º Windows
        run: flutter build windows --release

      - name: ğŸ“¦ æ‰“åŒ… ZIP
        shell: pwsh
        run: |
          Compress-Archive -Path "build/windows/x64/runner/Release/*" -DestinationPath "Kelivo_windows_$env:VERSION.zip"

      - name: ğŸš€ å‘å¸ƒåˆ° Release
        if: ${{ github.event.inputs.publish_release == 'true' && github.event.inputs.release_tag != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: ${{ github.event.inputs.release_tag }}
          files: Kelivo_windows_*.zip

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: Windows-ZIP
          path: Kelivo_windows_*.zip

  # Linux æ„å»º
  linux:
    if: ${{ github.event.inputs.build_linux == 'true' }}
    name: æ„å»º Linux
    runs-on: ubuntu-latest
    permissions: write-all

    steps:
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config libgtk-3-dev \
            libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
            gstreamer1.0-plugins-good gstreamer1.0-plugins-bad

      - name: ğŸ¦ å®‰è£… Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ğŸ“ è·å–ç‰ˆæœ¬å·
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: ğŸ—ï¸ æ„å»º Linux
        run: flutter build linux --release

      - name: ğŸ“¦ æ‰“åŒ… tar.gz
        run: |
          cd build/linux/x64/release/bundle
          tar -czf ../../../../../Kelivo_linux_${VERSION}.tar.gz .

      - name: ğŸš€ å‘å¸ƒåˆ° Release
        if: ${{ github.event.inputs.publish_release == 'true' && github.event.inputs.release_tag != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: ${{ github.event.inputs.release_tag }}
          files: Kelivo_linux_*.tar.gz

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: Linux-tar.gz
          path: Kelivo_linux_*.tar.gz
