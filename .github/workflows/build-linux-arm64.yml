name: Build Linux ARM64

env:
  FLUTTER_VERSION: '3.38.4'

on:
  workflow_dispatch:
    inputs:
      publish_release:
        description: 'å‘å¸ƒåˆ° Release'
        required: false
        default: false
        type: boolean

      release_tag:
        description: 'Release æ ‡ç­¾ï¼ˆå¦‚ v1.0.0ï¼‰'
        required: false
        default: ''
        type: string

      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬ (Pre-release)'
        required: false
        default: false
        type: boolean

jobs:
  linux-arm64:
    name: æ„å»º Linux ARM64
    # ä½¿ç”¨ GitHub æä¾›çš„ ARM64 runnerï¼ˆä»…å…¬å¼€ä»“åº“å¯ç”¨ï¼‰
    runs-on: ubuntu-24.04-arm
    permissions: write-all

    steps:
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config libgtk-3-dev \
            libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
            gstreamer1.0-plugins-good gstreamer1.0-plugins-bad \
            rpm patchelf libfuse2 file \
            libkeybinder-3.0-dev libayatana-appindicator3-dev

      - name: ğŸ¦ å®‰è£… Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ğŸ“ Inject fallback
        shell: bash
        run: |
          mkdir -p lib/secrets
          cat > lib/secrets/fallback.dart <<'EOF'
          const String siliconflowFallbackKey = '${{ secrets.SILICONFLOW_KEY }}';
          EOF

      - name: ğŸ“ è·å–ç‰ˆæœ¬å·
        run: |
          RAW_VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          VERSION=$RAW_VERSION
          if [ "${{ github.event.inputs.publish_release }}" != "true" ]; then
            SHORT_SHA=$(git rev-parse --short HEAD)
            VERSION="${VERSION}_${SHORT_SHA}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION_NUMBER=$(echo $RAW_VERSION | cut -d'+' -f1)" >> $GITHUB_ENV
          echo "ç‰ˆæœ¬å·: $VERSION"

      - name: ğŸ—ï¸ æ„å»º Linux ARM64
        run: flutter build linux --release

      - name: ğŸ“¦ æ‰“åŒ… tar.gz
        run: |
          cd build/linux/arm64/release/bundle
          tar -czf ../../../../../Kelivo_linux_${VERSION}_arm64.tar.gz .

      - name: ğŸ“¦ åˆ›å»º AppImage
        run: |
          # ä¸‹è½½ ARM64 ç‰ˆæœ¬çš„ appimagetool
          wget -O appimagetool "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-aarch64.AppImage"
          chmod +x appimagetool

          # åˆ›å»º AppDir ç»“æ„
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/lib
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          cp -r build/linux/arm64/release/bundle/* AppDir/usr/bin/

          # åˆ›å»º AppRun è„šæœ¬
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin:${PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
          exec "${HERE}/usr/bin/kelivo" "$@"
          EOF
          chmod +x AppDir/AppRun

          # åˆ›å»º desktop æ–‡ä»¶
          cat > AppDir/kelivo.desktop << EOF
          [Desktop Entry]
          Name=Kelivo
          Exec=kelivo
          Icon=kelivo
          Type=Application
          Categories=Utility;
          EOF

          ICON_SOURCE="linux/kelivo.png"
          if [ ! -f "$ICON_SOURCE" ]; then
            ICON_SOURCE="assets/app_icon.png"
          fi
          if [ ! -f "$ICON_SOURCE" ]; then
            echo "âŒ Icon source not found"
            exit 1
          fi
          install -Dm644 "$ICON_SOURCE" AppDir/kelivo.png
          install -Dm644 "$ICON_SOURCE" "AppDir/usr/share/icons/hicolor/256x256/apps/kelivo.png"

          # æ„å»º AppImage
          ARCH=aarch64 ./appimagetool AppDir Kelivo_linux_${VERSION}_arm64.AppImage

      - name: ğŸ“¦ åˆ›å»º DEB åŒ…
        run: |
          # åˆ›å»º DEB ç›®å½•ç»“æ„
          mkdir -p deb/DEBIAN
          mkdir -p deb/opt/kelivo
          mkdir -p deb/usr/share/applications
          mkdir -p deb/usr/share/icons/hicolor/256x256/apps

          # å¤åˆ¶æ–‡ä»¶
          cp -r build/linux/arm64/release/bundle/* deb/opt/kelivo/

          # åˆ›å»º control æ–‡ä»¶
          cat > deb/DEBIAN/control << EOF
          Package: kelivo
          Version: ${VERSION_NUMBER}
          Section: utils
          Priority: optional
          Architecture: arm64
          Maintainer: Psyche <your@email.com>
          Depends: libgtk-3-0, libstdc++6, libglu1-mesa, libgstreamer1.0-0, libgstreamer-plugins-base1.0-0, libglib2.0-0, libc6
          Description: Kelivo Application
           A Flutter application for Linux
          EOF

          # åˆ›å»º desktop æ–‡ä»¶
          cat > deb/usr/share/applications/kelivo.desktop << EOF
          [Desktop Entry]
          Name=Kelivo
          Exec=/opt/kelivo/kelivo
          Icon=kelivo
          Type=Application
          Categories=Utility;
          EOF

          ICON_SOURCE="linux/kelivo.png"
          if [ ! -f "$ICON_SOURCE" ]; then
            ICON_SOURCE="assets/app_icon.png"
          fi
          if [ ! -f "$ICON_SOURCE" ]; then
            echo "âŒ Icon source not found"
            exit 1
          fi
          install -Dm644 "$ICON_SOURCE" deb/usr/share/icons/hicolor/256x256/apps/kelivo.png

          # åˆ›å»ºå¯åŠ¨è„šæœ¬
          cat > deb/opt/kelivo/kelivo.sh << 'EOF'
          #!/bin/bash
          cd "$(dirname "$0")"
          ./kelivo "$@"
          EOF
          chmod +x deb/opt/kelivo/kelivo.sh

          # æ„å»º DEB åŒ…
          dpkg-deb --build deb Kelivo_linux_${VERSION}_arm64.deb

      - name: ğŸ“¦ åˆ›å»º RPM åŒ…
        run: |
          # åˆ›å»º RPM æ„å»ºç›®å½•
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}

          # åˆ›å»ºæºç ç›®å½•
          mkdir -p kelivo-${VERSION_NUMBER}
          cp -r build/linux/arm64/release/bundle/* kelivo-${VERSION_NUMBER}/
          ICON_SOURCE="linux/kelivo.png"
          if [ ! -f "$ICON_SOURCE" ]; then
            ICON_SOURCE="assets/app_icon.png"
          fi
          if [ ! -f "$ICON_SOURCE" ]; then
            echo "âŒ Icon source not found"
            exit 1
          fi
          cp "$ICON_SOURCE" kelivo-${VERSION_NUMBER}/kelivo.png
          tar -czf ~/rpmbuild/SOURCES/kelivo-${VERSION_NUMBER}.tar.gz kelivo-${VERSION_NUMBER}

          # åˆ›å»º spec æ–‡ä»¶
          cat > ~/rpmbuild/SPECS/kelivo.spec << EOF
          Name:           kelivo
          Version:        ${VERSION_NUMBER}
          Release:        1%{?dist}
          Summary:        Kelivo Application
          License:        MIT
          Source0:        %{name}-%{version}.tar.gz
          BuildArch:      aarch64
          Requires:       gtk3, libstdc++ >= 6, mesa-libGLU, gstreamer1, gstreamer1-plugins-base, glib2, glibc

          %description
          A Flutter application for Linux

          %prep
          %setup -q

          %install
          mkdir -p %{buildroot}/opt/kelivo
          cp -r * %{buildroot}/opt/kelivo/

          mkdir -p %{buildroot}/usr/share/applications
          cat > %{buildroot}/usr/share/applications/kelivo.desktop << 'DESKTOPEOF'
          [Desktop Entry]
          Name=Kelivo
          Exec=/opt/kelivo/kelivo
          Icon=kelivo
          Type=Application
          Categories=Utility;
          DESKTOPEOF

          mkdir -p %{buildroot}/usr/share/icons/hicolor/256x256/apps
          cp kelivo.png %{buildroot}/usr/share/icons/hicolor/256x256/apps/kelivo.png

          %files
          /opt/kelivo/*
          /usr/share/applications/kelivo.desktop
          /usr/share/icons/hicolor/256x256/apps/kelivo.png

          %changelog
          * $(date "+%a %b %d %Y") Psyche <your@email.com> - ${VERSION_NUMBER}-1
          - Initial RPM release
          EOF

          # æ„å»º RPM
          rpmbuild -bb ~/rpmbuild/SPECS/kelivo.spec
          cp ~/rpmbuild/RPMS/aarch64/kelivo-${VERSION_NUMBER}-1.*.rpm Kelivo_linux_${VERSION}_arm64.rpm
      - name: ğŸ” RPM å…ƒæ•°æ®ï¼ˆè°ƒè¯•ï¼‰
        shell: bash
        run: |
          set -euxo pipefail
          RPM_FILE="Kelivo_linux_${VERSION}_arm64.rpm"
          echo "RPM file: ${RPM_FILE}"
          cp -f ~/rpmbuild/SPECS/kelivo.spec rpm-spec.spec
          rpm -qp --info "${RPM_FILE}" | tee rpm-info.txt
          rpm -qp --requires "${RPM_FILE}" | tee rpm-requires.txt
          rpm -qp --provides "${RPM_FILE}" | tee rpm-provides.txt
      - name: ğŸ“¤ ä¸Šä¼  RPM å…ƒæ•°æ®ï¼ˆè°ƒè¯•ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: Linux-ARM64-RPM-Metadata
          path: |
            rpm-spec.spec
            rpm-info.txt
            rpm-requires.txt
            rpm-provides.txt
      - name: ğŸ§ª Fedora 43 å®‰è£…æµ‹è¯•
        shell: bash
        run: |
          set -euxo pipefail
          RPM_FILE="Kelivo_linux_${VERSION}_arm64.rpm"
          docker run --rm -v "${PWD}:/work" -w /work fedora:43 bash -lc "dnf -y install ./${RPM_FILE}"

      - name: ğŸš€ å‘å¸ƒåˆ° Release
        if: ${{ github.event.inputs.publish_release == 'true' && github.event.inputs.release_tag != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: ${{ github.event.inputs.release_tag }}
          prerelease: ${{ github.event.inputs.prerelease }}
          files: |
            Kelivo_linux_*_arm64.tar.gz
            Kelivo_linux_*_arm64.AppImage
            Kelivo_linux_*_arm64.deb
            Kelivo_linux_*_arm64.rpm

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰© (tar.gz)
        uses: actions/upload-artifact@v4
        with:
          name: Linux-ARM64-tar.gz
          path: Kelivo_linux_*_arm64.tar.gz

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰© (AppImage)
        uses: actions/upload-artifact@v4
        with:
          name: Linux-ARM64-AppImage
          path: Kelivo_linux_*_arm64.AppImage

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰© (DEB)
        uses: actions/upload-artifact@v4
        with:
          name: Linux-ARM64-DEB
          path: Kelivo_linux_*_arm64.deb

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰© (RPM)
        uses: actions/upload-artifact@v4
        with:
          name: Linux-ARM64-RPM
          path: Kelivo_linux_*_arm64.rpm
