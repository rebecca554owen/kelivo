name: Flutter Multi-Platform Build Stable 3.38

env:
  FLUTTER_VERSION: '3.38.4'  # ä¿®æ”¹ä¸ºä½ éœ€è¦çš„ Flutter ç‰ˆæœ¬

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      # é€‰æ‹©æ„å»ºçš„å¹³å°
      build_android:
        description: 'æ„å»º Android'
        required: false
        default: true
        type: boolean

      build_ios:
        description: 'æ„å»º iOS'
        required: false
        default: true
        type: boolean

      build_mac:
        description: 'æ„å»º macOS'
        required: false
        default: true
        type: boolean

      build_windows:
        description: 'æ„å»º Windows'
        required: false
        default: true
        type: boolean

      build_linux:
        description: 'æ„å»º Linux'
        required: false
        default: true
        type: boolean

      # æ˜¯å¦å‘å¸ƒåˆ° Releaseï¼ˆé»˜è®¤ä¸å‘å¸ƒï¼‰
      publish_release:
        description: 'å‘å¸ƒåˆ° Release'
        required: false
        default: false
        type: boolean

      # Release æ ‡ç­¾ï¼ˆåªæœ‰é€‰æ‹©å‘å¸ƒæ—¶æ‰éœ€è¦å¡«å†™ï¼‰
      release_tag:
        description: 'Release æ ‡ç­¾ï¼ˆå¦‚ v1.0.0ï¼‰'
        required: false
        default: ''
        type: string

      # æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬ (Pre-release)'
        required: false
        default: false
        type: boolean

jobs:
  # Android æ„å»º
  android:
    if: ${{ github.event.inputs.build_android == 'true' }}
    name: æ„å»º Android
    runs-on: ubuntu-latest
    permissions: write-all

    steps:
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• é…ç½® Java ç¯å¢ƒ
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: ğŸ¦ å®‰è£… Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ğŸ“ Inject fallback
        shell: bash
        run: |
          mkdir -p lib/secrets
          cat > lib/secrets/fallback.dart <<'EOF'
          const String siliconflowFallbackKey = '${{ secrets.SILICONFLOW_KEY }}';
          EOF
      - name: ğŸ“ è·å–ç‰ˆæœ¬å·
        id: version
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          if [ "${{ github.event.inputs.publish_release }}" != "true" ]; then
            SHORT_SHA=$(git rev-parse --short HEAD)
            VERSION="${VERSION}_${SHORT_SHA}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ç‰ˆæœ¬å·: $VERSION"
      # å¦‚æœæœ‰ç­¾åå¯†é’¥ï¼Œå†™å…¥å¯†é’¥æ–‡ä»¶
      - name: ğŸ”‘ å†™å…¥ç­¾åå¯†é’¥
        if: ${{ env.SIGN_KEYSTORE_BASE64 != '' }}
        env:
          SIGN_KEYSTORE_BASE64: ${{ secrets.SIGN_KEYSTORE_BASE64 }}
        run: |
          echo "$SIGN_KEYSTORE_BASE64" | base64 --decode > android/app/key.jks
          echo "storeFile=key.jks" >> android/key.properties
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          echo "âœ… ç­¾åé…ç½®å·²å†™å…¥"
      - name: ğŸ—ï¸ æ„å»º APK
        run: flutter build apk --release --split-per-abi

      - name: ğŸ“¦ é‡å‘½å APK
        run: |
          cd build/app/outputs/flutter-apk
          for file in app-*-release.apk; do
            abi=$(echo "$file" | sed -E 's/app-(.*)-release\.apk/\1/')
            mv "$file" "Kelivo_android_${VERSION}_${abi}.apk"
          done
      - name: ğŸš€ å‘å¸ƒåˆ° Release
        if: ${{ github.event.inputs.publish_release == 'true' && github.event.inputs.release_tag != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: ${{ github.event.inputs.release_tag }}
          prerelease: ${{ github.event.inputs.prerelease }}
          files: build/app/outputs/flutter-apk/Kelivo_android_*.apk

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰© (arm64-v8a)
        uses: actions/upload-artifact@v4
        with:
          name: Android-arm64-v8a
          path: build/app/outputs/flutter-apk/Kelivo_android_*_arm64-v8a.apk

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰© (armeabi-v7a)
        uses: actions/upload-artifact@v4
        with:
          name: Android-armeabi-v7a
          path: build/app/outputs/flutter-apk/Kelivo_android_*_armeabi-v7a.apk

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰© (x86_64)
        uses: actions/upload-artifact@v4
        with:
          name: Android-x86_64
          path: build/app/outputs/flutter-apk/Kelivo_android_*_x86_64.apk

  # iOS æ„å»º
  ios:
    if: ${{ github.event.inputs.build_ios == 'true' }}
    name: æ„å»º iOS
    runs-on: macos-latest
    permissions: write-all

    steps:
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ¦ å®‰è£… Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ğŸ“ Inject fallback
        shell: bash
        run: |
          mkdir -p lib/secrets
          cat > lib/secrets/fallback.dart <<'EOF'
          const String siliconflowFallbackKey = '${{ secrets.SILICONFLOW_KEY }}';
          EOF
      - name: ğŸ“ è·å–ç‰ˆæœ¬å·
        id: version
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          if [ "${{ github.event.inputs.publish_release }}" != "true" ]; then
            SHORT_SHA=$(git rev-parse --short HEAD)
            VERSION="${VERSION}_${SHORT_SHA}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ç‰ˆæœ¬å·: $VERSION"
      - name: ğŸ—ï¸ æ„å»º iOS (æ— ç­¾å)
        run: |
          flutter build ios --release --no-codesign
          cd build/ios/iphoneos
          mkdir Payload
          cp -r Runner.app Payload/
          zip -r ../../../Kelivo_ios_${VERSION}.ipa Payload
      - name: ğŸš€ å‘å¸ƒåˆ° Release
        if: ${{ github.event.inputs.publish_release == 'true' && github.event.inputs.release_tag != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: ${{ github.event.inputs.release_tag }}
          prerelease: ${{ github.event.inputs.prerelease }}
          files: Kelivo_ios_*.ipa

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: iOS-IPA
          path: Kelivo_ios_*.ipa

  # macOS æ„å»º
  macos:
    if: ${{ github.event.inputs.build_mac == 'true' }}
    name: æ„å»º macOS
    runs-on: macos-latest
    permissions: write-all

    steps:
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ¦ å®‰è£… Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ğŸ“ Inject fallback
        shell: bash
        run: |
          mkdir -p lib/secrets
          cat > lib/secrets/fallback.dart <<'EOF'
          const String siliconflowFallbackKey = '${{ secrets.SILICONFLOW_KEY }}';
          EOF
      - name: ğŸ“ è·å–ç‰ˆæœ¬å·
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          if [ "${{ github.event.inputs.publish_release }}" != "true" ]; then
            SHORT_SHA=$(git rev-parse --short HEAD)
            VERSION="${VERSION}_${SHORT_SHA}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
      - name: ğŸ—ï¸ æ„å»º macOS
        run: flutter build macos --release

      - name: ğŸ“¦ åˆ›å»º DMG
        run: |
          brew install create-dmg
          create-dmg \
            --volname "Kelivo" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --app-drop-link 600 185 \
            "Kelivo_macos_${VERSION}.dmg" \
            "build/macos/Build/Products/Release/kelivo.app" || true
          # å¦‚æœ create-dmg å¤±è´¥ï¼Œä½¿ç”¨ç®€å•æ–¹å¼
          if [ ! -f "Kelivo_macos_${VERSION}.dmg" ]; then
            hdiutil create -volname Kelivo -srcfolder build/macos/Build/Products/Release/kelivo.app -ov -format UDZO Kelivo_macos_${VERSION}.dmg
          fi
      - name: ğŸš€ å‘å¸ƒåˆ° Release
        if: ${{ github.event.inputs.publish_release == 'true' && github.event.inputs.release_tag != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: ${{ github.event.inputs.release_tag }}
          prerelease: ${{ github.event.inputs.prerelease }}
          files: Kelivo_macos_*.dmg

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: macOS-DMG
          path: Kelivo_macos_*.dmg

  # Windows æ„å»º
  windows:
    if: ${{ github.event.inputs.build_windows == 'true' }}
    name: æ„å»º Windows
    runs-on: windows-latest
    permissions: write-all

    steps:
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ å®‰è£…æœ€æ–° CMake
        uses: lukka/get-cmake@latest

      - name: ğŸ¦ å®‰è£… Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ğŸ“ Inject fallback
        shell: bash
        run: |
          mkdir -p lib/secrets
          cat > lib/secrets/fallback.dart <<'EOF'
          const String siliconflowFallbackKey = '${{ secrets.SILICONFLOW_KEY }}';
          EOF
      - name: ğŸ”§ è·å–ä¾èµ–
        run: flutter pub get

      - name: ğŸ” éªŒè¯ CMake ç‰ˆæœ¬
        shell: pwsh
        run: |
          Write-Host "æ£€æŸ¥ CMake ç‰ˆæœ¬..."
          cmake --version
          $cmakeVersion = (cmake --version | Select-String "cmake version" | ForEach-Object { $_.ToString() })
          Write-Host "å½“å‰ CMake: $cmakeVersion"
      - name: ğŸ“ è·å–ç‰ˆæœ¬å·
        shell: pwsh
        run: |
          $version = (Select-String -Path pubspec.yaml -Pattern "version:" | ForEach-Object { $_.Line.Split(":")[1].Trim() })
          if ("${{ github.event.inputs.publish_release }}" -ne "true") {
            $shortSha = git rev-parse --short HEAD
            $version = "$version`_$shortSha"
          }
          echo "VERSION=$version" >> $env:GITHUB_ENV
          Write-Host "ç‰ˆæœ¬å·: $version"
      - name: ğŸ—ï¸ æ„å»º Windows
        run: flutter build windows --release

      - name: ğŸ“¦ æ‰“åŒ… ZIP
        shell: pwsh
        run: |
          Compress-Archive -Path "build/windows/x64/runner/Release/*" -DestinationPath "Kelivo_windows_$env:VERSION.zip"
      - name: ğŸ”§ å®‰è£… Inno Setup
        run: choco install innosetup -y

      - name: ğŸ“¦ åˆ›å»ºå®‰è£…ç¨‹åº
        shell: pwsh
        run: |
          # è¯­è¨€æ–‡ä»¶æ£€æµ‹ï¼ˆä¸­æ–‡è¯­è¨€åŒ…åœ¨éƒ¨åˆ† Runner ç¼ºå¤±ï¼Œé¿å…ç¼–è¯‘å¤±è´¥ï¼‰
          $zhLangCompiler = "C:\\Program Files (x86)\\Inno Setup 6\\Languages\\ChineseSimplified.isl"
          $zhLangLocalDir = Join-Path (Get-Location) "Languages"
          $zhLangLocal = Join-Path $zhLangLocalDir "ChineseSimplified.isl"
          $languagesBlock = $null
          if (Test-Path $zhLangCompiler) {
            Write-Host "âœ… æ£€æµ‹åˆ°ä¸­æ–‡è¯­è¨€æ–‡ä»¶: $zhLangCompiler"
            $languagesBlock = @"
          [Languages]
          Name: "chinesesimplified"; MessagesFile: "compiler:Languages\ChineseSimplified.isl"
          Name: "english"; MessagesFile: "compiler:Default.isl"
          "@
          } else {
            Write-Host "âš ï¸ æœªåœ¨ Inno Setup å®‰è£…ç›®å½•æ‰¾åˆ°ä¸­æ–‡è¯­è¨€æ–‡ä»¶ï¼Œå°è¯•ä¸‹è½½åˆ°æœ¬åœ°é¡¹ç›®..."
            try {
              New-Item -ItemType Directory -Force -Path $zhLangLocalDir | Out-Null
              $uri = 'https://raw.githubusercontent.com/jrsoftware/issrc/main/Files/Languages/ChineseSimplified.isl'
              Invoke-WebRequest -Uri $uri -OutFile $zhLangLocal -UseBasicParsing -TimeoutSec 60
              if (Test-Path $zhLangLocal) {
                Write-Host "âœ… å·²ä¸‹è½½ä¸­æ–‡è¯­è¨€æ–‡ä»¶: $zhLangLocal"
                $languagesBlock = @"
          [Languages]
          Name: "chinesesimplified"; MessagesFile: "$zhLangLocal"
          Name: "english"; MessagesFile: "compiler:Default.isl"
          "@
              }
            } catch {
              Write-Host "âš ï¸ ä¸‹è½½ä¸­æ–‡è¯­è¨€æ–‡ä»¶å¤±è´¥: $($_.Exception.Message)"
            }
            if (-not $languagesBlock) {
              Write-Host "â„¹ï¸ å°†ä»…åŒ…å«è‹±æ–‡å®‰è£…å‘å¯¼"
              $languagesBlock = @"
          [Languages]
          Name: "english"; MessagesFile: "compiler:Default.isl"
          "@
            }
          }
          # åˆ›å»º Inno Setup è„šæœ¬
          $issContent = @"
          #define MyAppName "Kelivo"
          #define MyAppVersion "$env:VERSION"
          #define MyAppPublisher "Psyche"
          #define MyAppExeName "kelivo.exe"
          [Setup]
          AppId={{A7B8C9D0-E1F2-4A5B-8C9D-0E1F2A3B4C5D}}
          AppName={#MyAppName}
          AppVersion={#MyAppVersion}
          AppPublisher={#MyAppPublisher}
          DefaultDirName={autopf}\{#MyAppName}
          DefaultGroupName={#MyAppName}
          OutputDir=.
          OutputBaseFilename=Kelivo_windows_{#MyAppVersion}_setup
          Compression=lzma2
          SolidCompression=yes
          WizardStyle=modern
          ArchitecturesInstallIn64BitMode=x64
          ArchitecturesAllowed=x64
          UninstallDisplayIcon={app}\{#MyAppExeName}
          $languagesBlock
          [Tasks]
          Name: "desktopicon"; Description: "åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼"; GroupDescription: "é™„åŠ å›¾æ ‡:"
          [Files]
          Source: "build\windows\x64\runner\Release\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs
          [Icons]
          Name: "{group}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"
          Name: "{group}\å¸è½½ {#MyAppName}"; Filename: "{uninstallexe}"
          Name: "{autodesktop}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; Tasks: desktopicon
          [Run]
          Filename: "{app}\{#MyAppExeName}"; Description: "å¯åŠ¨ {#MyAppName}"; Flags: nowait postinstall skipifsilent
          "@
          
          # ä½¿ç”¨ UTF-8 BOM ä»¥ç¡®ä¿ä¸­æ–‡å­—ç¬¦åœ¨ Inno Setup ä¸­æ­£ç¡®è§£æ
          $issContent | Out-File -FilePath "installer.iss" -Encoding utf8BOM
          
          # ç¼–è¯‘å®‰è£…ç¨‹åº
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "installer.iss"
      - name: ğŸš€ å‘å¸ƒåˆ° Release
        if: ${{ github.event.inputs.publish_release == 'true' && github.event.inputs.release_tag != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: ${{ github.event.inputs.release_tag }}
          prerelease: ${{ github.event.inputs.prerelease }}
          files: |
            Kelivo_windows_*.zip
            Kelivo_windows_*_setup.exe
      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰© (ZIP)
        uses: actions/upload-artifact@v4
        with:
          name: Windows-ZIP
          path: Kelivo_windows_*.zip

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰© (Installer)
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Installer
          path: Kelivo_windows_*_setup.exe

  # Linux æ„å»º
  linux:
    if: ${{ github.event.inputs.build_linux == 'true' }}
    name: æ„å»º Linux
    runs-on: ubuntu-latest
    permissions: write-all

    steps:
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config libgtk-3-dev \
            libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
            gstreamer1.0-plugins-good gstreamer1.0-plugins-bad \
            rpm patchelf libfuse2 file \
            libkeybinder-3.0-dev libayatana-appindicator3-dev
      - name: ğŸ¦ å®‰è£… Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ğŸ“ Inject fallback
        shell: bash
        run: |
          mkdir -p lib/secrets
          cat > lib/secrets/fallback.dart <<'EOF'
          const String siliconflowFallbackKey = '${{ secrets.SILICONFLOW_KEY }}';
          EOF
      - name: ğŸ“ è·å–ç‰ˆæœ¬å·
        run: |
          RAW_VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          VERSION=$RAW_VERSION
          if [ "${{ github.event.inputs.publish_release }}" != "true" ]; then
            SHORT_SHA=$(git rev-parse --short HEAD)
            VERSION="${VERSION}_${SHORT_SHA}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION_NUMBER=$(echo $RAW_VERSION | cut -d'+' -f1)" >> $GITHUB_ENV
      - name: ğŸ—ï¸ æ„å»º Linux
        run: flutter build linux --release

      - name: ğŸ“¦ æ‰“åŒ… tar.gz
        run: |
          cd build/linux/x64/release/bundle
          tar -czf ../../../../../Kelivo_linux_${VERSION}.tar.gz .
      - name: ğŸ“¦ åˆ›å»º AppImage
        run: |
          # ä¸‹è½½ appimagetool
          wget -O appimagetool "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
          chmod +x appimagetool
          
          # åˆ›å»º AppDir ç»“æ„
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/lib
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          cp -r build/linux/x64/release/bundle/* AppDir/usr/bin/
          
          # åˆ›å»º AppRun è„šæœ¬
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin:${PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
          exec "${HERE}/usr/bin/kelivo" "$@"
          EOF
          chmod +x AppDir/AppRun
          
          # åˆ›å»º desktop æ–‡ä»¶
          cat > AppDir/kelivo.desktop << EOF
          [Desktop Entry]
          Name=Kelivo
          Exec=kelivo
          Icon=kelivo
          Type=Application
          Categories=Utility;
          EOF
          
          ICON_SOURCE="linux/kelivo.png"
          if [ ! -f "$ICON_SOURCE" ]; then
            ICON_SOURCE="assets/app_icon.png"
          fi
          if [ ! -f "$ICON_SOURCE" ]; then
            echo "âŒ Icon source not found"
            exit 1
          fi
          install -Dm644 "$ICON_SOURCE" AppDir/kelivo.png
          install -Dm644 "$ICON_SOURCE" "AppDir/usr/share/icons/hicolor/256x256/apps/kelivo.png"
          
          # æ„å»º AppImage
          ARCH=x86_64 ./appimagetool AppDir Kelivo_linux_${VERSION}.AppImage
      - name: ğŸ“¦ åˆ›å»º DEB åŒ…
        run: |
          # åˆ›å»º DEB ç›®å½•ç»“æ„
          mkdir -p deb/DEBIAN
          mkdir -p deb/opt/kelivo
          mkdir -p deb/usr/share/applications
          mkdir -p deb/usr/share/icons/hicolor/256x256/apps
          
          # å¤åˆ¶æ–‡ä»¶
          cp -r build/linux/x64/release/bundle/* deb/opt/kelivo/
          
          # åˆ›å»º /usr/bin è½¯é“¾æ¥
          mkdir -p deb/usr/bin
          ln -s /opt/kelivo/kelivo deb/usr/bin/kelivo
          
          # åˆ›å»º control æ–‡ä»¶
          cat > deb/DEBIAN/control << EOF
          Package: kelivo
          Version: ${VERSION_NUMBER}
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: Psyche <your@email.com>
          Depends: libgtk-3-0, libstdc++6, libglu1-mesa, libgstreamer1.0-0, libgstreamer-plugins-base1.0-0, libglib2.0-0, libc6
          Description: Kelivo Application
           A Flutter application for Linux
          EOF
          
          # åˆ›å»º desktop æ–‡ä»¶
          cat > deb/usr/share/applications/kelivo.desktop << EOF
          [Desktop Entry]
          Name=Kelivo
          Exec=/opt/kelivo/kelivo
          Icon=kelivo
          Type=Application
          Categories=Utility;
          EOF

          ICON_SOURCE="linux/kelivo.png"
          if [ ! -f "$ICON_SOURCE" ]; then
            ICON_SOURCE="assets/app_icon.png"
          fi
          if [ ! -f "$ICON_SOURCE" ]; then
            echo "âŒ Icon source not found"
            exit 1
          fi
          install -Dm644 "$ICON_SOURCE" deb/usr/share/icons/hicolor/256x256/apps/kelivo.png
          
          # åˆ›å»ºå¯åŠ¨è„šæœ¬
          cat > deb/opt/kelivo/kelivo.sh << 'EOF'
          #!/bin/bash
          cd "$(dirname "$0")"
          ./kelivo "$@"
          EOF
          chmod +x deb/opt/kelivo/kelivo.sh
          
          # æ„å»º DEB åŒ…
          dpkg-deb --build deb Kelivo_linux_${VERSION}_amd64.deb
      - name: ğŸ“¦ åˆ›å»º RPM åŒ…
        run: |
          # åˆ›å»º RPM æ„å»ºç›®å½•
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          
          # åˆ›å»ºæºç ç›®å½•
          mkdir -p kelivo-${VERSION_NUMBER}
          cp -r build/linux/x64/release/bundle/* kelivo-${VERSION_NUMBER}/
          ICON_SOURCE="linux/kelivo.png"
          if [ ! -f "$ICON_SOURCE" ]; then
            ICON_SOURCE="assets/app_icon.png"
          fi
          if [ ! -f "$ICON_SOURCE" ]; then
            echo "âŒ Icon source not found"
            exit 1
          fi
          cp "$ICON_SOURCE" kelivo-${VERSION_NUMBER}/kelivo.png
          tar -czf ~/rpmbuild/SOURCES/kelivo-${VERSION_NUMBER}.tar.gz kelivo-${VERSION_NUMBER}
          
          # åˆ›å»º spec æ–‡ä»¶
          cat > ~/rpmbuild/SPECS/kelivo.spec << EOF
          Name:           kelivo
          Version:        ${VERSION_NUMBER}
          Release:        1%{?dist}
          Summary:        Kelivo Application
          License:        MIT
          Source0:        %{name}-%{version}.tar.gz
          BuildArch:      x86_64
          Requires:       gtk3, libstdc++ >= 6, mesa-libGLU, gstreamer1, gstreamer1-plugins-base, glib2, glibc
          
          %description
          A Flutter application for Linux
          
          %prep
          %setup -q
          
          %install
          mkdir -p %{buildroot}/opt/kelivo
          cp -r * %{buildroot}/opt/kelivo/
          
          mkdir -p %{buildroot}/usr/bin
          ln -s /opt/kelivo/kelivo %{buildroot}/usr/bin/kelivo
          
          mkdir -p %{buildroot}/usr/share/applications
          cat > %{buildroot}/usr/share/applications/kelivo.desktop << 'DESKTOPEOF'
          [Desktop Entry]
          Name=Kelivo
          Exec=/opt/kelivo/kelivo
          Icon=kelivo
          Type=Application
          Categories=Utility;
          DESKTOPEOF

          mkdir -p %{buildroot}/usr/share/icons/hicolor/256x256/apps
          cp kelivo.png %{buildroot}/usr/share/icons/hicolor/256x256/apps/kelivo.png
          
          %files
          /opt/kelivo/*
          /usr/bin/kelivo
          /usr/share/applications/kelivo.desktop
          /usr/share/icons/hicolor/256x256/apps/kelivo.png
          
          %changelog
          * $(date "+%a %b %d %Y") Psyche <your@email.com> - ${VERSION_NUMBER}-1
          - Initial RPM release
          EOF
          
          # æ„å»º RPM
          rpmbuild -bb ~/rpmbuild/SPECS/kelivo.spec
          cp ~/rpmbuild/RPMS/x86_64/kelivo-${VERSION_NUMBER}-1.*.rpm Kelivo_linux_${VERSION}.rpm
      - name: ğŸ” RPM å…ƒæ•°æ®ï¼ˆè°ƒè¯•ï¼‰
        shell: bash
        run: |
          set -euxo pipefail
          RPM_FILE="Kelivo_linux_${VERSION}.rpm"
          echo "RPM file: ${RPM_FILE}"
          cp -f ~/rpmbuild/SPECS/kelivo.spec rpm-spec.spec
          rpm -qp --info "${RPM_FILE}" | tee rpm-info.txt
          rpm -qp --requires "${RPM_FILE}" | tee rpm-requires.txt
          rpm -qp --provides "${RPM_FILE}" | tee rpm-provides.txt
      - name: ğŸ“¤ ä¸Šä¼  RPM å…ƒæ•°æ®ï¼ˆè°ƒè¯•ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: Linux-RPM-Metadata
          path: |
            rpm-spec.spec
            rpm-info.txt
            rpm-requires.txt
            rpm-provides.txt
      - name: ğŸ§ª Fedora 43 å®‰è£…æµ‹è¯•
        shell: bash
        run: |
          set -euxo pipefail
          RPM_FILE="Kelivo_linux_${VERSION}.rpm"
          docker run --rm -v "${PWD}:/work" -w /work fedora:43 bash -lc "dnf -y install ./${RPM_FILE}"
      - name: ğŸš€ å‘å¸ƒåˆ° Release
        if: ${{ github.event.inputs.publish_release == 'true' && github.event.inputs.release_tag != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: ${{ github.event.inputs.release_tag }}
          prerelease: ${{ github.event.inputs.prerelease }}
          files: |
            Kelivo_linux_*.tar.gz
            Kelivo_linux_*.AppImage
            Kelivo_linux_*_amd64.deb
            Kelivo_linux_*.rpm
      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰© (tar.gz)
        uses: actions/upload-artifact@v4
        with:
          name: Linux-tar.gz
          path: Kelivo_linux_*.tar.gz

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰© (AppImage)
        uses: actions/upload-artifact@v4
        with:
          name: Linux-AppImage
          path: Kelivo_linux_*.AppImage

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰© (DEB)
        uses: actions/upload-artifact@v4
        with:
          name: Linux-DEB
          path: Kelivo_linux_*_amd64.deb

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰© (RPM)
        uses: actions/upload-artifact@v4
        with:
          name: Linux-RPM
          path: Kelivo_linux_*.rpm